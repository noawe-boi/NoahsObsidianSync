/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ie=Object.create;var x=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,re=Object.prototype.hasOwnProperty;var V=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports),le=(a,t)=>{for(var e in t)x(a,e,{get:t[e],enumerable:!0})},W=(a,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ae(t))!re.call(a,i)&&i!==e&&x(a,i,{get:()=>t[i],enumerable:!(s=ne(t,i))||s.enumerable});return a};var y=(a,t,e)=>(e=a!=null?ie(oe(a)):{},W(t||!a||!a.__esModule?x(e,"default",{value:a,enumerable:!0}):e,a)),ue=a=>W(x({},"__esModule",{value:!0}),a);var G=V(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.VOLUME=w.RATE=w.PITCH=w.OUTPUT_FORMAT=void 0;var K;(function(a){a.AUDIO_24KHZ_48KBITRATE_MONO_MP3="audio-24khz-48kbitrate-mono-mp3",a.AUDIO_24KHZ_96KBITRATE_MONO_MP3="audio-24khz-96kbitrate-mono-mp3",a.WEBM_24KHZ_16BIT_MONO_OPUS="webm-24khz-16bit-mono-opus"})(K||(w.OUTPUT_FORMAT=K={}));var X;(function(a){a.X_LOW="x-low",a.LOW="low",a.MEDIUM="medium",a.HIGH="high",a.X_HIGH="x-high",a.DEFAULT="default"})(X||(w.PITCH=X={}));var Q;(function(a){a.X_SLOW="x-slow",a.SLOW="slow",a.MEDIUM="medium",a.FAST="fast",a.X_FAST="x-fast",a.DEFAULT="default"})(Q||(w.RATE=Q={}));var Z;(function(a){a.SILENT="silent",a.X_SOFT="x-soft",a.SOFT="soft",a.MEDIUM="medium",a.LOUD="loud",a.X_LOUD="x-LOUD",a.DEFAULT="default"})(Z||(w.VOLUME=Z={}))});var H=V(b=>{"use strict";var Y=b&&b.__awaiter||function(a,t,e,s){function i(n){return n instanceof e?n:new e(function(o){o(n)})}return new(e||(e=Promise))(function(n,o){function u(l){try{r(s.next(l))}catch(S){o(S)}}function c(l){try{r(s.throw(l))}catch(S){o(S)}}function r(l){l.done?n(l.value):i(l.value).then(u,c)}r((s=s.apply(a,t||[])).next())})};Object.defineProperty(b,"__esModule",{value:!0});b.EdgeTTSClient=b.ProsodyOptions=void 0;var J=require("buffer"),de=G();typeof globalThis.Buffer=="undefined"&&(globalThis.Buffer=J.Buffer);function ge(a){let t=new Uint8Array(a);return window.crypto.getRandomValues(t),Array.from(t,e=>`0${e.toString(16)}`.slice(-2)).join("")}var q=class{constructor(){this.eventListeners={data:[],close:[],end:[]}}on(t,e){this.eventListeners[t].push(e)}emit(t,e){this.eventListeners[t].forEach(s=>s(e))}},I=class{constructor(){this.pitch="+0Hz",this.rate=1,this.volume=100}};b.ProsodyOptions=I;var g=class{constructor(t=!1){this.ws=null,this.voice=null,this.voiceLocale=null,this.outputFormat=null,this.requestQueue={},this.connectionStartTime=0,this.enableLogging=t,this.isBrowser=typeof window!="undefined"&&typeof window.document!="undefined"}log(...t){this.enableLogging&&console.log(...t)}sendMessage(t){return Y(this,void 0,void 0,function*(){var e,s;for(let i=1;i<=3&&((e=this.ws)===null||e===void 0?void 0:e.readyState)!==WebSocket.OPEN;i++)i===1&&(this.connectionStartTime=Date.now()),this.log(`Connecting... attempt ${i}`),yield this.initWebSocket();(s=this.ws)===null||s===void 0||s.send(t)})}initWebSocket(){this.ws=new WebSocket(g.SYNTH_URL),this.ws.binaryType="arraybuffer";let t=[];return new Promise((e,s)=>{this.ws.onopen=()=>{this.log("Connected in",(Date.now()-this.connectionStartTime)/1e3,"seconds"),this.sendMessage(this.getConfigMessage()).then(e)},this.ws.onmessage=i=>this.handleMessage(i,t),this.ws.onclose=()=>this.handleClose(),this.ws.onerror=i=>s(`Connection Error: ${i}`)})}handleMessage(t,e){var s;let i=J.Buffer.from(t.data),n=i.toString(),o=/X-RequestId:(.*?)\r\n/.exec(n),u=o?o[1]:"";if(n.includes("Path:turn.start"))e.length=0;else if(n.includes("Path:turn.end"))(s=this.requestQueue[u])===null||s===void 0||s.emit("end",e);else if(n.includes("Path:audio"))this.cacheAudioData(i,u);else if(n.includes("Path:audio.metadata")){let c=n.indexOf("{");e.push(JSON.parse(n.slice(c)).Metadata[0])}else this.log("Unknown Message",n)}handleClose(){this.log("Disconnected after:",(Date.now()-this.connectionStartTime)/1e3,"seconds");for(let t in this.requestQueue)this.requestQueue[t].emit("close",null)}cacheAudioData(t,e){var s;let i=new TextEncoder().encode(g.BINARY_DELIM),n=this.findDelimiterIndex(t,i);if(n===-1){this.log("Delimiter not found in the buffer.");return}let o=n+i.length,u=t.slice(o);(s=this.requestQueue[e])===null||s===void 0||s.emit("data",u),this.log("Received audio chunk of size:",u==null?void 0:u.length)}findDelimiterIndex(t,e){for(let s=0;s<=t.length-e.length;s++){let i=!0;for(let n=0;n<e.length;n++)if(t[s+n]!==e[n]){i=!1;break}if(i)return s}return-1}getConfigMessage(){return`Content-Type:application/json; charset=utf-8\r
Path:speech.config\r
\r
{
            "context": {
                "synthesis": {
                    "audio": {
                        "metadataoptions": {
                            "sentenceBoundaryEnabled": "true",
                            "wordBoundaryEnabled": "true"
                        },
                        "outputFormat": "${this.outputFormat}"
                    }
                }
            }
        }`}getVoices(){return fetch(g.VOICES_URL).then(t=>t.json()).catch(t=>Promise.reject(t))}setMetadata(t,e,s){return Y(this,void 0,void 0,function*(){if(this.voice=t,this.outputFormat=e,this.voiceLocale=s||this.inferLocaleFromVoiceName(t),!this.voiceLocale)throw new Error("Could not infer voiceLocale from voiceName!");(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.connectionStartTime=Date.now(),yield this.initWebSocket())})}inferLocaleFromVoiceName(t){let e=g.VOICE_LANG_REGEX.exec(t);return e?e[0]:null}close(){var t;(t=this.ws)===null||t===void 0||t.close()}toStream(t,e=new I){return this.sendSSMLRequest(this.buildSSML(t,e))}buildSSML(t,e){return`<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xmlns:mstts="https://www.w3.org/2001/mstts" xml:lang="${this.voiceLocale}">
            <voice name="${this.voice}">
                <prosody pitch="${e.pitch}" rate="${e.rate}" volume="${e.volume}">
                    ${t}
                </prosody>
            </voice>
        </speak>`}sendSSMLRequest(t){if(!this.ws)throw new Error("WebSocket not initialized. Call setMetadata first.");let e=ge(16),s=`X-RequestId:${e}\r
Content-Type:application/ssml+xml\r
Path:ssml\r
\r
${t.trim()}`,i=new q;return this.requestQueue[e]=i,this.sendMessage(s).then(),i}};b.EdgeTTSClient=g;g.OUTPUT_FORMAT=de.OUTPUT_FORMAT;g.CLIENT_TOKEN="6A5AA1D4EAFF4E9FB37E23D68491D6F4";g.VOICES_URL=`https://speech.platform.bing.com/consumer/speech/synthesize/readaloud/voices/list?trustedclienttoken=${g.CLIENT_TOKEN}`;g.SYNTH_URL=`wss://speech.platform.bing.com/consumer/speech/synthesize/readaloud/edge/v1?TrustedClientToken=${g.CLIENT_TOKEN}`;g.BINARY_DELIM=`Path:audio\r
`;g.VOICE_LANG_REGEX=/\w{2}-\w{2}/});var B=V(p=>{"use strict";Object.defineProperty(p,"__esModule",{value:!0});p.VOLUME=p.RATE=p.PITCH=p.OUTPUT_FORMAT=p.ProsodyOptions=p.EdgeTTSClient=void 0;var he=H();Object.defineProperty(p,"EdgeTTSClient",{enumerable:!0,get:function(){return he.EdgeTTSClient}});var pe=H();Object.defineProperty(p,"ProsodyOptions",{enumerable:!0,get:function(){return pe.ProsodyOptions}});var O=G();Object.defineProperty(p,"OUTPUT_FORMAT",{enumerable:!0,get:function(){return O.OUTPUT_FORMAT}});Object.defineProperty(p,"PITCH",{enumerable:!0,get:function(){return O.PITCH}});Object.defineProperty(p,"RATE",{enumerable:!0,get:function(){return O.RATE}});Object.defineProperty(p,"VOLUME",{enumerable:!0,get:function(){return O.VOLUME}})});var we={};le(we,{default:()=>L});module.exports=ue(we);var f=require("obsidian");var d=require("obsidian"),ce=["en-US-AvaMultilingualNeural","en-US-BrianMultilingualNeural","en-US-AndrewNeural","en-US-AriaNeural","en-US-AvaNeural","en-US-ChristopherNeural","en-US-SteffanNeural","en-IE-ConnorNeural","en-GB-RyanNeural","en-GB-SoniaNeural","en-AU-NatashaNeural","en-AU-WilliamNeural"],z={selectedVoice:"en-US-AvaNeural",customVoice:"",playbackSpeed:1,showNotices:!0,showStatusBarButton:!0,showMenuItems:!0,generateMP3:!1,outputFolder:"Note Narration Audio",embedInNote:!1,replaceSpacesInFilenames:!1,overrideAmpersandEscape:!1},$="note",C=class extends d.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}async display(){let{containerEl:e}=this;e.empty();let s=e.createEl("div",{cls:"edge-tts-info-div"}),i=document.createElement("p"),n=document.createElement("a");n.href="https://tts.travisvn.com",n.text="tts.travisvn.com",i.append("You can sample available voices at "),i.append(n),s.appendChild(i),new d.Setting(e).setName("Select voice").setDesc("Choose from the top voices.").setClass("default-style").addDropdown(r=>{ce.forEach(l=>{r.addOption(l,l)}),r.setValue(this.plugin.settings.selectedVoice),r.onChange(async l=>{this.plugin.settings.selectedVoice=l,await this.plugin.saveSettings()})});let o=document.createDocumentFragment(),u=document.createElement("a");u.href="https://tts.travisvn.com",u.text="tts.travisvn.com",o.append("(OPTIONAL) Enter custom voice. Visit "),o.append(u),o.append(" for list of options. "),o.append("Leave empty to use the selected voice above."),new d.Setting(e).setName("Custom voice").setDesc(o).addText(r=>{r.setPlaceholder("e.g., fr-FR-HenriNeural"),r.setValue(this.plugin.settings.customVoice),r.onChange(async l=>{this.plugin.settings.customVoice=l,await this.plugin.saveSettings()})}),new d.Setting(e).setName("Playback speed").setDesc("Change playback speed multiplier (ex. 0.5 = 0.5x playback speed (50% speed)). Default = 1.0").addSlider(r=>{r.setLimits(.5,2,.1),r.setValue(this.plugin.settings.playbackSpeed),r.onChange(async l=>{this.plugin.settings.playbackSpeed=l,await this.plugin.saveSettings()}),r.setDynamicTooltip(),r.showTooltip()}),new d.Setting(e).setName("Show notices").setDesc("Toggle notices for processing status and errors.").addToggle(r=>{r.setValue(this.plugin.settings.showNotices),r.onChange(async l=>{this.plugin.settings.showNotices=l,await this.plugin.saveSettings()})}),new d.Setting(e).setName("Show status bar button").setDesc("Toggle playback button in the status bar.").addToggle(r=>{r.setValue(this.plugin.settings.showStatusBarButton),r.onChange(async l=>{this.plugin.settings.showStatusBarButton=l,await this.plugin.saveSettings(),l?this.plugin.uiManager.initializeStatusBar():this.plugin.uiManager.removeStatusBarButton()})}),new d.Setting(e).setName("Show file and editor menu items").setDesc("Toggle menu items in the file and editor menus.").addToggle(r=>{r.setValue(this.plugin.settings.showMenuItems),r.onChange(async l=>{this.plugin.settings.showMenuItems=l,await this.plugin.saveSettings(),l?this.plugin.uiManager.addPluginMenuItems():new d.Notice("Menu items will be removed after the next reload.")})}),e.createEl("h3",{text:"Saving .mp3 of narration"}),new d.Setting(e).setName("Generate MP3 file").setDesc('Enable option to select "Generate MP3" in the file and editor menus.').addToggle(r=>{r.setValue(this.plugin.settings.generateMP3),r.onChange(async l=>{this.plugin.settings.generateMP3=l,await this.plugin.saveSettings(),l||new d.Notice("Menu items will be removed after the next reload.")})}),new d.Setting(e).setName("Output folder").setDesc("Specify the folder to save generated MP3 files.").addText(r=>{r.setPlaceholder("e.g., Note Narration Audio").setValue(this.plugin.settings.outputFolder).onChange(async l=>{this.plugin.settings.outputFolder=l.trim(),await this.plugin.saveSettings()})}),new d.Setting(e).setName("Embed MP3 in note").setDesc("Embed a link to the generated MP3 file in the note.").addToggle(r=>{r.setValue(this.plugin.settings.embedInNote),r.onChange(async l=>{this.plugin.settings.embedInNote=l,await this.plugin.saveSettings()})}),new d.Setting(e).setName("Replace spaces in filenames").setDesc("Replaces spaces in mp3 file name with underscores (used for system compatibility).").addToggle(r=>{r.setValue(this.plugin.settings.replaceSpacesInFilenames),r.onChange(async l=>{this.plugin.settings.replaceSpacesInFilenames=l,await this.plugin.saveSettings()})});let c=e.createEl("div",{cls:"edge-tts-star-section"});c.createEl("p",{text:"Please star this project on GitHub if you find it useful \u2B50\uFE0F",cls:"edge-tts-star-message"}),c.createEl("a",{text:"GitHub: Edge TTS Plugin",href:"https://github.com/travisvn/obsidian-edge-tts",cls:"external-link",attr:{target:"_blank",rel:"noopener"}}),e.createEl("h3",{text:"Extra Settings"}),new d.Setting(e).setName("Override ampersand (&) escaping").setDesc('If an ampersand (&) is by itself, we "escape it" for the API call. This override is an option for rare use cases.').addToggle(r=>{r.setValue(this.plugin.settings.overrideAmpersandEscape),r.onChange(async l=>{this.plugin.settings.overrideAmpersandEscape=l,await this.plugin.saveSettings()})})}};var v=require("obsidian"),k=y(B());function N(a){let t=/^(---|\.\.\.)([\s\S]*?)\1\n?/;return a.replace(t,"").trim()}function fe(a){return a.replace(/>=/g,"\u2265").replace(/<=/g,"\u2264")}function me(a){return a.replace(/&/g,"&amp;")}function Te(a){return a.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function A(a,t=!1){let n=a.replace(/^-{3}[\s\S]*?-{3}\n?/,"").replace(/https?:\/\/[^\s]+/g,"").replace(/```[\s\S]*?```/g,"").replace(/^( {4}|\t).+/gm,"").replace(/(\*\*|__)(.*?)\1/g,"$2").replace(/(\*|_)(.*?)\1/g,"$2").replace(/`([^`]*)`/g,"$1").replace(/~~(.*?)~~/g,"$1").replace(/^[#*-]+\s*/gm,"").replace(/^[\-\+\*]\s+/gm,"").replace(/^\d+\.\s+/gm,"").replace(/^>\s+/gm,"").replace(/^[-*]{3,}\s*$/gm,"");return n=fe(n),n=n.replace(/<([^>\s]+)[^>]*>/g,""),n=t?n.trim():me(n.trim()),Te(n)}var _=class{constructor(t,e){this.audioContext=null;this.audioSource=null;this.isPaused=!1;this.pausedAt=0;this.settings=t,this.updateStatusBarCallback=e}async startPlayback(t){if((this.audioContext||this.audioSource)&&this.stopPlayback(),!t.trim()){this.settings.showNotices&&new v.Notice("No text selected or available.");return}let e=A(N(t),this.settings.overrideAmpersandEscape);if(!e.trim()){this.settings.showNotices&&new v.Notice("No readable text after filtering.");return}try{this.settings.showNotices&&new v.Notice("Processing text-to-speech..."),this.updateStatusBarCallback(!0);let s=new k.EdgeTTSClient,i=this.settings.customVoice.trim()||this.settings.selectedVoice;await s.setMetadata(i,k.OUTPUT_FORMAT.WEBM_24KHZ_16BIT_MONO_OPUS);let n=new k.ProsodyOptions;n.rate=this.settings.playbackSpeed;let o=s.toStream(e,n);this.audioContext=new AudioContext,this.audioSource=this.audioContext.createBufferSource();let u=[];o.on("data",c=>{u.push(c)}),o.on("end",async()=>{let c=new Uint8Array(Buffer.concat(u)),r=await this.audioContext.decodeAudioData(c.buffer);this.audioSource.buffer=r,this.audioSource.connect(this.audioContext.destination),this.audioSource.start(0),this.audioSource.onended=()=>{this.cleanupAudioContext(),this.updateStatusBarCallback(!1),this.settings.showNotices&&new v.Notice("Finished reading aloud.")}})}catch(s){console.error("Error reading note aloud:",s),this.updateStatusBarCallback(!1),this.settings.showNotices&&new v.Notice("Failed to read note aloud.")}}pausePlayback(){this.audioContext&&this.audioSource&&(this.isPaused=!0,this.pausedAt=this.audioContext.currentTime,this.audioContext.suspend(),this.updateStatusBarCallback(!0))}resumePlayback(){this.audioContext&&(this.isPaused=!1,this.audioContext.resume(),this.updateStatusBarCallback(!0))}stopPlayback(){this.audioSource&&(this.audioSource.stop(),this.cleanupAudioContext(),this.updateStatusBarCallback(!1))}cleanupAudioContext(){this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.audioSource=null,this.isPaused=!1,this.pausedAt=0}isPlaybackPaused(){return this.isPaused}isPlaying(){return this.audioContext!==null&&this.audioSource!==null}updateSettings(t){this.settings=t}};var h=require("obsidian");var M=y(require("path")),ee=y(require("os")),F=class{constructor(t,e){this.app=t,this.settings=e}async extractFileContent(t){let e=this.app.vault.getAbstractFileByPath(t);if(e instanceof h.TFile)try{return await this.app.vault.read(e)}catch(s){return console.error("Error reading file content:",s),null}else return console.warn("The specified file is not a TFile (markdown file)."),null}async embedMP3InNote(t,e,s){try{if(s){let i=s.getSelection(),n=s.getCursor("to"),o=`

![[${t}]]
`;i?s.replaceSelection(`${i}${o}`):s.replaceRange(o,n),this.settings.showNotices&&new h.Notice("MP3 embedded after the selected text.")}else{if(!e){console.error("Error embedding MP3 in note due to filePath and editor not being passed to embedMP3InNote"),this.settings.showNotices&&new h.Notice("Failed to embed MP3 in note.");return}let i=this.app.vault.getAbstractFileByPath(e);if(!(i instanceof h.TFile)){this.settings.showNotices&&new h.Notice(`File not found or is not a valid markdown file: ${e}`);return}let n=await this.app.vault.read(i),o=`![[${t}]]`,u=`${n}

${o}`;await this.app.vault.modify(i,u),this.settings.showNotices&&new h.Notice("MP3 embedded in note.")}}catch(i){console.error("Error embedding MP3 in note:",i),this.settings.showNotices&&new h.Notice("Failed to embed MP3 in note.")}}async saveMP3File(t,e){let s=this.app.vault.adapter;if(!(s instanceof h.FileSystemAdapter))return console.error("File system adapter not available."),this.settings.showNotices&&new h.Notice("Unable to save MP3 file."),null;let i=s.getBasePath(),n=this.settings.replaceSpacesInFilenames?"Note_Narration_Audio":"Note Narration Audio",u=this.settings.outputFolder||n,c=M.join(i,u);try{await s.exists(u)||await s.mkdir(u);let r=(0,h.getLanguage)(),l=new Date,m=new Intl.DateTimeFormat(r,{month:"short",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).format(l).replace(/,/g,"").trim();ee.platform()==="win32"&&(m=m.replace(/:/g,"-"));let E=e?M.basename(e,".md")||$:$;this.settings.replaceSpacesInFilenames&&(E=E.replace(/\s+/g,"_"),m=m.replace(/\s+/g,"_"));let j=this.settings.replaceSpacesInFilenames?`${E}_-_${m}.mp3`:`${E} - ${m}.mp3`,R=M.join(u,j),se=M.join(c,j);return await s.write(R,""),await s.writeBinary(R,t),this.settings.showNotices&&new h.Notice(`MP3 saved to: ${se}`),R}catch(r){return console.error("Error saving MP3:",r),this.settings.showNotices&&new h.Notice("Failed to save MP3 file."),null}}updateSettings(t){this.settings=t}};var T=require("obsidian");var P=y(B());var D=class{constructor(t){this.tasks=new Map;this.processingQueue=[];this.isProcessing=!1;this.settings=t}createTask(t,e){let s=A(N(t),this.settings.overrideAmpersandEscape);if(!s.trim())throw new Error("No readable text after filtering");let i=`tts-${Date.now()}-${Math.floor(Math.random()*1e3)}`,n=this.settings.customVoice.trim()||this.settings.selectedVoice,o={id:i,text:s,status:"pending",progress:0,createdAt:new Date,outputFormat:e,voice:n,playbackSpeed:this.settings.playbackSpeed};return this.tasks.set(i,o),this.processingQueue.push(i),this.isProcessing||this.processNextTask(),o}async processNextTask(){if(this.processingQueue.length===0){this.isProcessing=!1;return}this.isProcessing=!0;let t=this.processingQueue.shift(),e=this.tasks.get(t);if(!e){setTimeout(()=>this.processNextTask(),0);return}e.status="processing",this.tasks.set(t,e);try{let s=new P.EdgeTTSClient;await s.setMetadata(e.voice,e.outputFormat);let i=new P.ProsodyOptions;i.rate=e.playbackSpeed;let n=s.toStream(e.text,i),o=[],u=e.text.length*50,c=0;n.on("data",r=>{o.push(r),c+=r.length,e.progress=Math.min(99,Math.floor(c/u*100)),this.tasks.set(t,e)}),await new Promise((r,l)=>{n.on("end",()=>{let m=Buffer.concat(o);e.buffer=m,e.status="completed",e.progress=100,e.completedAt=new Date,this.tasks.set(t,e),r()});let S=setTimeout(()=>{e.status!=="completed"&&(e.status="failed",e.error="Timed out waiting for TTS stream to complete",this.tasks.set(t,e),l(new Error("TTS processing timeout")))},6e4);n.on("end",()=>{clearTimeout(S)})})}catch(s){e.status="failed",e.error=s.message||"Unknown error",this.tasks.set(t,e),console.error("TTS generation error:",s)}setTimeout(()=>this.processNextTask(),10)}getTask(t){return this.tasks.get(t)}getAllTasks(){return Array.from(this.tasks.values())}cleanupOldTasks(t=36e5){let e=new Date().getTime();for(let[s,i]of this.tasks.entries())(i.status==="completed"||i.status==="failed")&&e-i.createdAt.getTime()>t&&this.tasks.delete(s)}async generateAudioBuffer(t){try{let e=A(N(t),this.settings.overrideAmpersandEscape);if(!e.trim())throw new Error("No readable text after filtering");let s=this.settings.customVoice.trim()||this.settings.selectedVoice,i=new P.EdgeTTSClient;await i.setMetadata(s,P.OUTPUT_FORMAT.WEBM_24KHZ_16BIT_MONO_OPUS);let n=new P.ProsodyOptions;n.rate=this.settings.playbackSpeed;let o=i.toStream(e,n),u=[];return new Promise((c,r)=>{o.on("data",S=>{u.push(S)}),o.on("end",async()=>{let S=new Uint8Array(Buffer.concat(u));try{let E=await new AudioContext().decodeAudioData(S.buffer);c(E)}catch(m){r(m)}});let l=setTimeout(()=>{r(new Error("TTS processing timeout"))},3e4);o.on("end",()=>{clearTimeout(l)})})}catch(e){return console.error("Error generating audio buffer:",e),null}}updateSettings(t){this.settings=t}};var U=class{constructor(t,e,s,i){this.statusBarEl=null;this.ribbonIconEl=null;this.plugin=t,this.settings=e,this.audioManager=s,this.ttsEngine=i}initializeStatusBar(){this.statusBarEl=this.plugin.addStatusBarItem(),this.updateStatusBar()}removeStatusBarButton(){this.statusBarEl&&(this.statusBarEl.remove(),this.statusBarEl=null)}updateStatusBar(t=!1){if(!this.statusBarEl)return;if(!this.settings.showStatusBarButton){this.removeStatusBarButton();return}if(this.statusBarEl.empty(),this.hasActiveTasks())this.renderTaskProgressIndicator();else if(t){let s=createEl("span",{cls:"edge-tts-status-bar-control"});(0,T.setTooltip)(s,this.audioManager.isPlaybackPaused()?"Resume":"Pause",{placement:"top"}),(0,T.setIcon)(s,this.audioManager.isPlaybackPaused()?"circle-play":"circle-pause"),s.onclick=()=>this.audioManager.isPlaybackPaused()?this.audioManager.resumePlayback():this.audioManager.pausePlayback(),this.statusBarEl.appendChild(s);let i=createEl("span",{cls:"edge-tts-status-bar-control"});(0,T.setTooltip)(i,"Stop",{placement:"top"}),(0,T.setIcon)(i,"square"),i.onclick=()=>this.audioManager.stopPlayback(),this.statusBarEl.appendChild(i)}else{let s=createEl("span",{cls:"edge-tts-status-bar-control"});(0,T.setTooltip)(s,"Read note aloud",{placement:"top"}),(0,T.setIcon)(s,"audio-lines"),s.onclick=()=>this.plugin.readNoteAloud(),this.statusBarEl.appendChild(s)}}renderTaskProgressIndicator(){if(!this.statusBarEl||!this.ttsEngine)return;let t=this.ttsEngine.getAllTasks(),e=t.filter(o=>o.status==="processing"),s=t.filter(o=>o.status==="pending"),i=createEl("div",{cls:"edge-tts-status-bar-progress-container"}),n=createEl("span",{cls:"edge-tts-status-bar-icon"});if((0,T.setIcon)(n,"cpu"),i.appendChild(n),e.length>0){let o=e[0],u=createEl("span",{cls:"edge-tts-status-bar-text",text:`${o.progress}%`});i.appendChild(u);let c=e.length+s.length,r=c>1?`${c} tasks`:"1 task";(0,T.setTooltip)(i,`Processing TTS: ${r}`,{placement:"top"})}else if(s.length>0){let o=createEl("span",{cls:"edge-tts-status-bar-text",text:"Waiting..."});i.appendChild(o);let u=s.length,c=u>1?`${u} tasks`:"1 task";(0,T.setTooltip)(i,`Waiting to process: ${c}`,{placement:"top"})}this.statusBarEl.appendChild(i)}hasActiveTasks(){return this.ttsEngine?this.ttsEngine.getAllTasks().some(e=>e.status==="pending"||e.status==="processing"):!1}addPluginRibbonIcon(){this.ribbonIconEl&&this.ribbonIconEl.remove(),this.ribbonIconEl=this.plugin.addRibbonIcon("audio-lines","Read note aloud",()=>{this.plugin.readNoteAloud()})}removePluginRibbonIcon(){this.ribbonIconEl&&(this.ribbonIconEl.remove(),this.ribbonIconEl=null)}addPluginMenuItems(){this.plugin.registerEvent(this.plugin.app.workspace.on("file-menu",(t,e)=>{t.addItem(s=>{s.setTitle("Read note aloud").setIcon("audio-lines").onClick(async()=>{this.plugin.readNoteAloud(void 0,void 0,e.path)})}),this.settings.generateMP3&&t.addItem(s=>{s.setTitle("Generate MP3").setIcon("microphone").onClick(async()=>{await this.plugin.generateMP3(void 0,void 0,e.path)})})})),this.plugin.registerEvent(this.plugin.app.workspace.on("editor-menu",(t,e,s)=>{t.addItem(i=>{i.setTitle("Read note aloud").setIcon("audio-lines").onClick(async()=>{this.plugin.readNoteAloud(e,s)})}),this.settings.generateMP3&&t.addItem(i=>{i.setTitle("Generate MP3").setIcon("microphone").onClick(async()=>{await this.plugin.generateMP3(e,s)})})}))}setTTSEngine(t){this.ttsEngine=t}updateSettings(t){this.settings=t}};var te=y(B()),L=class extends f.Plugin{constructor(){super(...arguments);this.mp3GenerationTasks=new Map}async onload(){await this.loadSettings(),this.ttsEngine=new D(this.settings),this.audioManager=new _(this.settings,this.updateStatusBar.bind(this)),this.fileManager=new F(this.app,this.settings),this.uiManager=new U(this,this.settings,this.audioManager,this.ttsEngine),this.addSettingTab(new C(this.app,this)),this.uiManager.addPluginRibbonIcon(),this.settings.showStatusBarButton&&this.uiManager.initializeStatusBar(),this.settings.showMenuItems&&this.uiManager.addPluginMenuItems(),this.registerInterval(window.setInterval(()=>this.monitorTasks(),1e3)),this.addCommand({id:"read-note-aloud",name:"Read note aloud",editorCallback:(e,s)=>{this.readNoteAloud(e,s)}}),this.addCommand({id:"generate-mp3",name:"Generate MP3",editorCallback:(e,s)=>{this.generateMP3(e,s)}}),this.addCommand({id:"stop-tts-playback",name:"Stop TTS playback",callback:()=>{this.audioManager.stopPlayback()}})}monitorTasks(){for(let[e,s]of this.mp3GenerationTasks.entries()){let i=this.ttsEngine.getTask(s.taskId);if(!i){this.mp3GenerationTasks.delete(e);continue}i.status==="completed"&&i.buffer?(this.mp3GenerationTasks.delete(e),this.fileManager.saveMP3File(i.buffer,s.filePath).then(n=>{n&&this.settings.embedInNote&&this.fileManager.embedMP3InNote(n,s.filePath,s.editor)}),this.settings.showNotices&&new f.Notice("MP3 generation complete")):i.status==="failed"&&(this.mp3GenerationTasks.delete(e),this.settings.showNotices&&new f.Notice(`MP3 generation failed: ${i.error||"Unknown error"}`))}Math.random()<.0033&&this.ttsEngine.cleanupOldTasks()}updateStatusBar(e=!1){this.uiManager.updateStatusBar(e)}async readNoteAloud(e,s,i){let n="";if(i){let o=await this.fileManager.extractFileContent(i);if(o)n=o;else{this.settings.showNotices&&new f.Notice("Failed to read note aloud.");return}}else{let o=s!=null?s:this.app.workspace.getActiveViewOfType(f.MarkdownView);!e&&o&&(e=o.editor),e&&o&&(n=e.getSelection()||e.getValue())}await this.audioManager.startPlayback(n)}async generateMP3(e,s,i){let n="";if(i){let o=await this.fileManager.extractFileContent(i);if(o)n=o;else{this.settings.showNotices&&new f.Notice("Failed to generate MP3: could not read file.");return}}else{let o=s!=null?s:this.app.workspace.getActiveViewOfType(f.MarkdownView);!e&&o&&(e=o.editor),e&&o&&(n=e.getSelection()||e.getValue())}if(!n.trim()){this.settings.showNotices&&new f.Notice("No text selected or available.");return}try{this.settings.showNotices&&new f.Notice("Starting MP3 generation in background...");let o=this.ttsEngine.createTask(n,te.OUTPUT_FORMAT.AUDIO_24KHZ_48KBITRATE_MONO_MP3),u=`mp3-${Date.now()}`;this.mp3GenerationTasks.set(u,{taskId:o.id,editor:e,filePath:i})}catch(o){console.error("Error starting MP3 generation:",o),this.settings.showNotices&&new f.Notice("Failed to start MP3 generation.")}}async loadSettings(){this.settings=Object.assign({},z,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.audioManager.updateSettings(this.settings),this.fileManager.updateSettings(this.settings),this.uiManager.updateSettings(this.settings),this.ttsEngine.updateSettings(this.settings)}onunload(){console.log("Unloading Obsidian Edge TTS Plugin"),this.uiManager.removePluginRibbonIcon(),this.audioManager.cleanupAudioContext(),this.uiManager.removeStatusBarButton()}};

/* nosourcemap */